*记录时间：2025年4月14日*

---

# 网络编程基础（2025.4.14）

## 1. 网络分层模型

### ISO/OSI 七层模型与 TCP/IP 四层模型对照

| OSI 七层模型 | TCP/IP 四层模型 | 描述 |
|--------------|-----------------|------|
| 应用层       | 应用层         | 提供用户接口和应用程序服务（如 HTTP、FTP） |
| 表示层       |                | 数据格式化、加密、压缩 |
| 会话层       |                | 管理会话、同步通信 |
| 传输层       | 传输层         | 提供端到端可靠数据传输（如 TCP、UDP） |
| 网络层       | 网络层         | 负责数据包路由和转发（如 IP、ICMP） |
| 数据链路层   | 网络接口层     | 局域网数据传输、帧封装（如以太网、ARP） |
| 物理层       |                | 物理介质传输（如电缆、光纤） |

- **数据传递流程**：
  - **正向组帧**：应用层 → 传输层（加协议数据单元 PDU）→ 网络层（加 IP 头）→ 数据链路层（加 MAC 帧）→ 物理层（比特流）。
  - **逆向拆帧**：物理层 → 数据链路层 → 网络层 → 传输层 → 应用层。
  - **逻辑通信**：发生在不同主机同一层之间。
  - **实际通信**：发生在上下层之间及物理层与硬件之间。

- **通信约定**：不仅需通信，还要对内容格式、语义等进行协议约定。

---

## 2. 网络设备与协议

### 网络设备

| 设备     | 工作层次                     | 功能 |
|----------|-----------------------------|------|
| 交换机   | 数据链路层、物理层           | 局域网内数据帧转发 |
| 路由器   | 网络层、数据链路层、物理层   | 跨网络数据包路由 |

### 协议分层

#### 应用层
- **实体**：操作系统进程。
- **常见协议**：
  - **HTTP/HTTPS**：网页浏览。
  - **SSH/Telnet**：远程命令（SSH 加密，Telnet 不加密）。
  - **FTP**：文件传输。
  - **POP3/SMTP**：电子邮件。
  - **RTMP**：视频直播。
- **协议类型**：
  - **公开协议**：以 RFC 文档形式公开（如 HTTP）。
  - **私有协议**：如 QQ IM、游戏协议（注重低延迟、弱网优化）、KCP 协议、金融量化协议。

#### 传输层
- **协议**：
  - **TCP**：可靠、面向连接（如打电话），全双工、有序。
  - **UDP**：不可靠、无连接（如发短信），适合实时性要求高的场景。
  - **SCTP**：支持多流、多宿主，较少使用。
- **功能**：提供端到端通信，区分进程（通过端口号）。

#### 网络层
- **协议**：
  - **IP**：数据包路由。
  - **ICMP**：网络诊断（如 ping）。
  - **IGMP**：组播管理。
- **功能**：实现跨网络的点对点通信。

#### 数据链路层
- **协议**：ARP（地址解析协议）。
- **功能**：局域网内数据帧传递。

---

## 3. 地址体系

| 地址类型   | 长度       | 作用                             | 所属层次       |
|------------|------------|----------------------------------|----------------|
| MAC 地址   | 48 位      | 局域网内主机标识                 | 数据链路层     |
| IP 地址    | IPv4: 32 位<br>IPv6: 128 位 | 网络中主机标识                   | 网络层         |
| 端口号     | 16 位 (0-65535) | 区分同一主机上的不同进程         | 传输层         |

- **NAT 技术**：
  - **作用**：将内网 IP 转换为公网 IP，缓解 IPv4 地址短缺。
  - **缺点**：内网设备只能作为客户端，无法直接接受外部连接。

---

## 4. 数据链路层详解

- **功能**：负责局域网内数据传递。
- **标准**：以太网（Ethernet）。
- **协议数据单元**：帧（Frame）。
  - **帧结构**：
    - **帧头**：目的 MAC 地址、源 MAC 地址。
    - **载荷**：上层 PDU（如 IP 数据包）。
    - **帧尾**：CRC（循环冗余校验），用于差错检测。
  - **差错处理**：发现错误则丢包，不重传。
- **差错检测**：
  - **方法**：哈希函数（如 CRC、MD5、SHA1）。
  - **特点**：以太网使用 CRC，碰撞概率低，但计算耗时。

---

## 5. 网络层详解

- **目标**：实现因特网上任意主机间的点对点通信。
- **原理**：
  - **基础**：相邻主机直接通信。
  - **方法**：逐跳传输，找到起点到终点的路径（每次传给离终点最近的节点）。
- **缺陷**：
  - 可能找不到终点。
  - 可能出现后发先至。
  - 可能形成环路。
  - 丢包不重传（不可靠）。
- **IP 分片**：
  - **场景**：数据包过大时，拆分为小片。
  - **过程**：
    1. 去掉原 IP 头。
    2. 每个分片添加新 IP 头，标识同一原始包的分片。
  - **标识**：通过分片 ID 区分属于同一原始包的分片。

---

## 6. 传输层详解

### TCP 协议

- **特点**：
  - **可靠**：丢包重传。
  - **全双工**：支持双向通信。
  - **有序**：通过序号保证顺序。
  - **端到端**：仅支持单播。
- **可靠性实现**：
  - **ACK 机制**：接收方回复确认包（ACK）。
  - **定时器**：发送方未收到 ACK 则重传。
  - **序号**：区分新包与重传包，解决重复数据问题。
- **滑动窗口**：
  - **作用**：控制发送速率，适应接收方能力。
  - **影响**：窗口大小受接收方缓冲区限制。
- **连接状态**：
  - **已连接**：通信有效。
  - **未连接**：通信无效，但网络层仍可传输。

### TCP 三次握手

- **目的**：建立可靠连接，确保双方同步初始序号。
- **过程**：
  1. **客户端**发送 SYN，进入 **SYN_SENT**。
  2. **服务器**收到 SYN，回复 SYN-ACK，进入 **SYN_RECV**。
  3. **客户端**收到 SYN-ACK，回复 ACK，进入 **ESTABLISHED**；服务器收到 ACK，进入 **ESTABLISHED**。
- **状态**：
  - **LISTEN**：服务器监听。
  - **SYN_SENT**：客户端等待确认。
  - **SYN_RECV**：服务器等待最终确认。
  - **ESTABLISHED**：连接建立。
- **两次握手的缺点**：
  - 服务器保持半连接状态，浪费资源。
  - 易受恶意攻击（如 SYN 洪泛）。

### TCP 四次挥手

- **目的**：安全关闭连接，确保数据传输完成。
- **过程**：
  1. **主动方**发送 FIN，进入 **FIN_WAIT_1**。
  2. **被动方**回复 ACK，进入 **CLOSE_WAIT**。
  3. **被动方**发送 FIN，进入 **LAST_ACK**。
  4. **主动方**回复 ACK，进入 **TIME_WAIT**，最终进入 **CLOSED**；被动方收到 ACK 后进入 **CLOSED**。
- **状态**：
  - **FIN_WAIT_1**：主动方等待 ACK。
  - **CLOSE_WAIT**：被动方处理剩余数据。
  - **LAST_ACK**：被动方等待最终确认。
  - **TIME_WAIT**：主动方等待确认包到达（持续 2MSL）。
  - **CLOSED**：连接关闭。
- **丢包处理**：
  - **数据或 ACK 丢失**：重传数据（ACK 被动重发）。
  - **第四次挥手丢包**：TIME_WAIT 状态延迟关闭，尽力确保连接正常终止。

---

## 7. 网络工具与命令

### Wireshark 抓包工具

- **功能**：捕获并分析网络数据包。
- **操作流程**：
  1. 选择网卡。
  2. 开始/停止抓包。
  3. 使用筛选表达式（如 `arp`、`ip`、`tcp`、`udp`、`http`）。
- **筛选技巧**：
  - 协议名直接输入。
  - 使用 `&&` 表示逻辑与。
- **分析**：按层次查看包内容。

### 常用命令

- **ifconfig**：
  - 查看网络接口信息。
  - **环回设备**（lo）：本地进程间通信无需经过网卡，直接走内核环回。

---

## 8. 总结

- **网络分层**：从物理层到应用层，各层功能明确，协议协同工作。
- **数据传递**：正向组帧、逆向拆帧，逻辑通信与实际通信分离。
- **协议与地址**：各层协议（如 TCP、IP、ARP）和地址（MAC、IP、端口）共同实现通信。
- **TCP 可靠性**：通过三次握手、四次挥手、ACK 机制、滑动窗口等确保可靠通信。
- **工具与命令**：Wireshark、ifconfig 等帮助分析和调试网络。

--- 
